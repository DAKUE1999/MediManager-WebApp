@model MediManager_WebApp.Models.ViewModels.StockViewModel

@{
    ViewData["Title"] = "Medikament einlagern";
}

<div class="container-fluid">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Warehouse" asp-action="Index">Lager</a></li>
            <li class="breadcrumb-item"><a asp-action="Index" asp-route-warehouseId="@ViewBag.WarehouseId">@ViewBag.WarehouseName</a></li>
            <li class="breadcrumb-item active" aria-current="page">Einlagern</li>
        </ol>
    </nav>

    <h1>@ViewData["Title"]</h1>

    <div class="row">
        <div class="col-md-6">
            <form asp-action="Create" method="post">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <input type="hidden" asp-for="WarehouseID" />
                <input type="hidden" asp-for="MedicationID" id="selectedMedicationId" />

                <div class="card">
                    <div class="card-body">
                        <!-- Medikamentengruppe -->
                        <div class="form-group mb-3">
                            <label class="control-label">Medikamentengruppe</label>
                            <div class="input-group">
                                <input type="text" id="selectedGroupDisplay" class="form-control" readonly 
                                       placeholder="Bitte wählen Sie eine Gruppe aus" 
                                       value="@Model.MedicationGroupName" />
                                <button type="button" class="btn btn-outline-secondary" onclick="showGroupSelector()">
                                    Auswählen
                                </button>
                            </div>
                            <input type="hidden" asp-for="MedicationGroupID" id="selectedGroupId" />
                            <span asp-validation-for="MedicationGroupID" class="text-danger"></span>
                        </div>

                        <!-- Medikament (wird nach Gruppenauswahl aktiviert) -->
                        <div class="form-group mb-3">
                            <label class="control-label">Medikament</label>
                            <div class="input-group">
                                <input type="text" id="selectedMedicationDisplay" class="form-control" readonly 
                                       placeholder="Wählen Sie zuerst eine Gruppe aus" 
                                       value="@Model.MedicationName" />
                                <button type="button" class="btn btn-outline-secondary" onclick="showMedicationSelector()" id="medicationSelectorBtn" disabled>
                                    Auswählen
                                </button>
                            </div>
                            <span asp-validation-for="MedicationID" class="text-danger"></span>
                        </div>

                        <!-- Regal -->
                        <div class="form-group mb-3">
                            <label asp-for="ShelfID" class="control-label">Regal</label>
                            <select asp-for="ShelfID" class="form-select" asp-items="ViewBag.Shelves">
                                <option value="">-- Bitte wählen --</option>
                            </select>
                            <span asp-validation-for="ShelfID" class="text-danger"></span>
                        </div>

                        <!-- Charge -->
                        <div class="form-group mb-3">
                            <label asp-for="Batch" class="control-label">Charge</label>
                            <input asp-for="Batch" class="form-control" />
                            <span asp-validation-for="Batch" class="text-danger"></span>
                        </div>

                        <!-- Seriennummer -->
                        <div class="form-group mb-3">
                            <label asp-for="SerialNumber" class="control-label">Seriennummer</label>
                            <input asp-for="SerialNumber" class="form-control" />
                            <span asp-validation-for="SerialNumber" class="text-danger"></span>
                        </div>

                        <!-- Verfallsdatum -->
                        <div class="form-group mb-3">
                            <label asp-for="ExpiryDate" class="control-label">Verfallsdatum</label>
                            <input asp-for="ExpiryDate" class="form-control" type="date" />
                            <span asp-validation-for="ExpiryDate" class="text-danger"></span>
                        </div>

                        <!-- Menge -->
                        <div class="form-group mb-3">
                            <label asp-for="Quantity" class="control-label">Menge</label>
                            <input asp-for="Quantity" class="form-control" type="number" min="1" />
                            <span asp-validation-for="Quantity" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">Einlagern</button>
                            <a asp-action="Index" asp-route-warehouseId="@ViewBag.WarehouseId" class="btn btn-secondary">Zurück zur Liste</a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal für Gruppenauswahl -->
<div class="modal fade" id="groupSelectorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Medikamentengruppe auswählen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col">
                        <input type="text" id="groupSearchInput" class="form-control" placeholder="Suchen..." />
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="groupsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Versorgungsnummer</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var group in ViewBag.MedicationGroups)
                            {
                                <tr onclick="selectGroup(@group.ID, '@group.Name')" style="cursor: pointer;">
                                    <td>@group.Name</td>
                                    <td>@group.SupplyNumber</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal für Medikamentenauswahl -->
<div class="modal fade" id="medicationSelectorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Medikament auswählen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col">
                        <input type="text" id="medicationSearchInput" class="form-control" placeholder="Suchen..." />
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="medicationsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>PZN</th>
                                <th>Hersteller</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        let groupModal, medicationModal;

        // Modal initialisieren
        document.addEventListener('DOMContentLoaded', function () {
            groupModal = new bootstrap.Modal(document.getElementById('groupSelectorModal'));
            medicationModal = new bootstrap.Modal(document.getElementById('medicationSelectorModal'));
        });

        // Gruppen Modal
        function showGroupSelector() {
            groupModal.show();
        }

        function selectGroup(id, name) {
            document.getElementById('selectedGroupId').value = id;
            document.getElementById('selectedGroupDisplay').value = name;
            document.getElementById('selectedMedicationId').value = '';
            document.getElementById('selectedMedicationDisplay').value = '';
            document.getElementById('medicationSelectorBtn').disabled = false;
            groupModal.hide();
            
            // Lade Medikamente für diese Gruppe
            loadMedicationsForGroup(id);
        }

        // Medikamenten Modal
        function showMedicationSelector() {
            medicationModal.show();
        }

        function selectMedication(id, name) {
            document.getElementById('selectedMedicationId').value = id;
            document.getElementById('selectedMedicationDisplay').value = name;
            medicationModal.hide();
        }

        // Medikamente laden
        function loadMedicationsForGroup(groupId) {
            fetch(`/Stock/GetMedicationsForGroup/${groupId}`)
                .then(response => response.json())
                .then(medications => {
                    const tbody = document.querySelector('#medicationsTable tbody');
                    tbody.innerHTML = '';
                    
                    medications.forEach(med => {
                        const tr = document.createElement('tr');
                        tr.style.cursor = 'pointer';
                        tr.onclick = () => selectMedication(med.id, med.name);
                        tr.innerHTML = `
                            <td>${med.name}</td>
                            <td>${med.pzn}</td>
                            <td>${med.manufacturer}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
        }

        // Suche in den Modals
        function setupSearch(searchId, tableId) {
            document.getElementById(searchId).addEventListener('keyup', function() {
                const searchText = this.value.toLowerCase();
                const table = document.getElementById(tableId);
                const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

                for (let row of rows) {
                    const cells = row.getElementsByTagName('td');
                    let found = false;
                    for (let cell of cells) {
                        if (cell.textContent.toLowerCase().indexOf(searchText) > -1) {
                            found = true;
                            break;
                        }
                    }
                    row.style.display = found ? '' : 'none';
                }
            });
        }

        setupSearch('groupSearchInput', 'groupsTable');
        setupSearch('medicationSearchInput', 'medicationsTable');
    </script>
}